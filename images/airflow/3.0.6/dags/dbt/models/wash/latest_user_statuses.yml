version: 2

models:
  - name: latest_user_statuses
    description: "Table that associates each customer with their most recent account configs"
    data_tests:
      # If this fails, it means that stripesubscriptions and subscriptionactivity are out of sync
      - except_equality:
          arguments:
            compare_model: "dry.stripesubscriptions"
            model_columns: [customer_id, subscription_type, default_order_size, wants_double_autofill, cycle, wants_breakfast_autofill, wants_surcharged_autofill, on_commitment='committed']
            compare_model_columns: [userid, typeid, default_meal_count, double, default_ship_period, COALESCE(autofill_breakfast_ok, FALSE), COALESCE(autofill_surcharge_ok, FALSE), commitment]
            model_condition: "user_status = 'active'"
            compare_model_condition: "active AND userid IN (SELECT lead_id FROM {{ ref('leads') }})"
    columns:
      - name: status_id
        description: "Primary Key"
        data_tests:
          - primary_key
      - name: customer_id
        description: "Customer whose first status this is"
        data_tests:
          - primary_key
