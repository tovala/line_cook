version: 2

models:
  - name: historic_oven_registrations
    data_tests:
      - unique_columns:
          arguments:
            unique_column_list:
              - oven_registration_id
            where_clause: "is_most_recent_record"
      - unique_columns:
          arguments:
            unique_column_list:
              - oven_hardware_id
            where_clause: "is_most_recent_record"
      - unique_columns:
          arguments:
            unique_column_list:
              - customer_id
            where_clause: "is_most_recent_record_for_customer"
      # A device ID should have only one serial number.
      - unique_columns:
          arguments:
            unique_column_list:
              - oven_hardware_id
            count_value: "DISTINCT serial_number"
            where_clause: "serial_number IS NOT NULL"
    columns:
      - name: ovens_history_id
        data_tests:
          - primary_key
      - name: customer_id
        data_tests:
          - not_null
      - name: oven_hardware_id
        data_tests:
          - not_null
      - name: oven_registration_id
        data_tests:
          - not_null
      - name: first_customer_registration_time
        data_tests:
          - not_null
      - name: serial_number
        data_tests:
            # Serial numbers are only valid if they follow this format
            - expression_is_true:
                arguments:
                  expression: "LIKE 'TOVMN%'"
                  condition: "serial_number IS NOT NULL AND NOT (current_hardware_group IN ('ENG_DEVELOPMENT_TEST', '2022-08_AirvalaKitchenOvens', 'SCL_DEV') OR current_hardware_group LIKE 'DEV%')"
